{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('multi_grn.index') }}">Multiple GRN</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('multi_grn.create_step2_select_pos', batch_id=batch.id) }}">Step 2: POs</a></li>
            <li class="breadcrumb-item active">Step 3: Item Details</li>
        </ol>
    </nav>

    <div class="card">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-0"><i data-feather="package"></i> Step 3: Item Details - Multi GRN</h4>
                <small>Batch: {{ batch.batch_number }} | Customer: {{ batch.customer_name }}</small>
            </div>
            <div>
                <span class="badge bg-light text-dark">{{ batch.po_links|length }} PO(s) Selected</span>
            </div>
        </div>
        <div class="card-body">
            <!-- Instructions -->
            <div class="alert alert-info">
                <i data-feather="info"></i>
                <strong>Instructions:</strong> For each line item, click "Add Item" to enter details such as Number of Bags, Warehouse, Bin Location, and generate QR labels.
            </div>

            <!-- PO and Line Items Table -->
            {% for po_link in batch.po_links %}
            <div class="card mb-4 border-primary">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i data-feather="file-text"></i> PO #{{ po_link.po_doc_num }}
                        <span class="badge bg-secondary ms-2">{{ po_link.line_selections|length }} Item(s)</span>
                    </h5>
                    <small class="text-muted">Doc Entry: {{ po_link.po_doc_entry }} | Vendor: {{ po_link.po_card_name }}</small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 5%;">#</th>
                                    <th style="width: 15%;">Item Code</th>
                                    <th style="width: 25%;">Description</th>
                                    <th style="width: 10%;">Ordered Qty</th>
                                    <th style="width: 10%;">Received Qty</th>
                                    <th style="width: 10%;">Warehouse</th>
                                    <th style="width: 10%;">Bin Location</th>
                                    <th style="width: 10%;">No. of Bags</th>
                                    <th style="width: 5%;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for line in po_link.line_selections %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td><strong>{{ line.item_code }}</strong></td>
                                    <td>{{ line.item_description }}</td>
                                    <td>{{ line.ordered_quantity }}</td>
                                    <td>
                                        <span id="qty_{{ line.id }}">{{ line.selected_quantity }}</span>
                                    </td>
                                    <td>
                                        <span id="warehouse_{{ line.id }}">{{ line.warehouse_code or '-' }}</span>
                                    </td>
                                    <td>
                                        <span id="bin_{{ line.id }}">{{ line.bin_location or '-' }}</span>
                                    </td>
                                    <td>
                                        <span id="bags_{{ line.id }}">
                                            {% if line.batch_details %}
                                                {{ line.batch_details|length }}
                                            {% elif line.serial_details %}
                                                {{ line.serial_details|length }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-success" 
                                                onclick='showAddItemModal({{ po_link.id }}, {{ line.id }}, {{ line.item_code|tojson }}, {{ line.item_description|tojson }}, {{ line.selected_quantity }}, {{ line.warehouse_code|tojson }})'>
                                            <i data-feather="plus"></i> Add Item
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% if not po_link.line_selections %}
                                <tr>
                                    <td colspan="9" class="text-center text-muted">
                                        <i data-feather="alert-circle"></i> No line items selected for this PO
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endfor %}

            <!-- Navigation Buttons -->
            <div class="d-flex justify-content-between mt-4">
                <a href="{{ url_for('multi_grn.create_step2_select_pos', batch_id=batch.id) }}" 
                   class="btn btn-secondary">
                    <i data-feather="arrow-left"></i> Back to Step 2
                </a>
                <div>
                    <button type="button" class="btn btn-success me-2" onclick="addManualItem()">
                        <i data-feather="plus-circle"></i> Add Manual Item
                    </button>
                    <a href="{{ url_for('multi_grn.create_step4_review', batch_id=batch.id) }}" 
                       class="btn btn-primary">
                        Next: Review <i data-feather="arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Item to GRN Modal (Matches GRPO functionality) -->
<div class="modal fade" id="addItemModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i data-feather="package"></i> Add Item to GRN</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="addItemForm">
                <div class="modal-body">
                    <!-- Item Code and Name -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="item_code" class="form-label">Item Code <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="item_code" name="item_code" 
                                       onchange="validateItemCode()" readonly required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="item_name" class="form-label">Item Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="item_name" name="item_name" readonly required>
                            </div>
                        </div>
                    </div>

                    <!-- Quantity and UoM -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="quantity" class="form-label">Quantity <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="quantity" name="quantity" 
                                       step="0.001" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="unit_of_measure" class="form-label">Unit of Measure (UoM) <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="unit_of_measure" name="unit_of_measure" 
                                       value="Manual" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Warehouse and Bin Location -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="warehouse_code" class="form-label">Warehouse <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="warehouse_code" name="warehouse_code" required>
                                <small class="form-text text-muted">Warehouse code from Purchase Order</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="bin_location" class="form-label">Bin Location</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="bin_location" name="bin_location" 
                                           placeholder="e.g., 7000-FG-J-840">
                                    <button class="btn btn-outline-secondary" type="button" onclick="editBinLocation()" 
                                            title="Edit bin location">
                                        <i data-feather="edit-3"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Expiration Date (Optional) -->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="expiration_date" class="form-label">Expiration Date (Optional)</label>
                                <input type="date" class="form-control" id="expiration_date" name="expiration_date">
                            </div>
                        </div>
                    </div>

                    <!-- Number of Bags with Generate Labels Button -->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="number_of_bags" class="form-label">Number of Bag</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="number_of_bags" name="number_of_bags" 
                                           placeholder="Enter number of bags for label printing" min="1" max="1000" value="1">
                                    <button class="btn btn-success" type="button" onclick="generateQRLabels()" 
                                            title="Generate QR labels for bags">
                                        <i data-feather="printer"></i> Generate Labels
                                    </button>
                                </div>
                                <small class="form-text text-muted">
                                    Enter the number of bags to generate QR labels with PO, GRN date, expiry, item details 
                                    (e.g., 5 will generate labels 1 of 5, 2 of 5, etc.)
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden fields -->
                    <input type="hidden" id="po_link_id" name="po_link_id">
                    <input type="hidden" id="line_selection_id" name="line_selection_id">
                    <input type="hidden" id="batch_id" name="batch_id" value="{{ batch.id }}">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i data-feather="save"></i> Add Item
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- QR Labels Preview Modal -->
<div class="modal fade" id="qrLabelsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i data-feather="printer"></i> QR Code Labels</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="qrLabelsContent">
                <!-- Labels will be generated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="window.print()">
                    <i data-feather="printer"></i> Print Labels
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
    let currentLineId = null;
    let currentPoLinkId = null;

    // Show Add Item Modal
    function showAddItemModal(poLinkId, lineId, itemCode, itemName, quantity, warehouseCode) {
        currentLineId = lineId;
        currentPoLinkId = poLinkId;

        // Populate form fields
        document.getElementById('po_link_id').value = poLinkId;
        document.getElementById('line_selection_id').value = lineId;
        document.getElementById('item_code').value = itemCode;
        document.getElementById('item_name').value = itemName;
        document.getElementById('quantity').value = quantity;
        document.getElementById('warehouse_code').value = warehouseCode || '7000-FG';
        document.getElementById('bin_location').value = '';
        document.getElementById('expiration_date').value = '';
        document.getElementById('number_of_bags').value = 1;

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('addItemModal'));
        modal.show();
    }

    // Validate Item Code from SAP
    function validateItemCode() {
        const itemCode = document.getElementById('item_code').value;
        if (!itemCode) return;

        console.log(`üîç Validating item: ${itemCode}`);

        fetch(`/multi-grn/validate-item/${itemCode}`)
            .then(response => response.json())
            .then(data => {
                console.log('‚úÖ Validation result:', data);

                if (data.success) {
                    if (data.item_name) {
                        document.getElementById('item_name').value = data.item_name;
                    }
                    if (data.uom) {
                        document.getElementById('unit_of_measure').value = data.uom;
                    }
                } else {
                    alert('‚ö†Ô∏è Item validation failed: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('‚ùå Error validating item:', error);
                alert('Error validating item code. Please check and try again.');
            });
    }

    // Edit Bin Location
    function editBinLocation() {
        document.getElementById('bin_location').focus();
    }

    // Generate QR Labels
    function generateQRLabels() {
        const numberOfBags = parseInt(document.getElementById('number_of_bags').value);
        const itemCode = document.getElementById('item_code').value;
        const itemName = document.getElementById('item_name').value;
        const quantity = document.getElementById('quantity').value;
        const expiryDate = document.getElementById('expiration_date').value;
        const warehouseCode = document.getElementById('warehouse_code').value;
        const binLocation = document.getElementById('bin_location').value;
        const batchId = document.getElementById('batch_id').value;

        if (!itemCode) {
            alert('Please select an item first');
            return;
        }

        if (!numberOfBags || numberOfBags < 1) {
            alert('Please enter a valid number of bags (minimum 1)');
            return;
        }

        if (numberOfBags > 1000) {
            alert('Maximum 1000 labels can be generated at once');
            return;
        }

        // Generate labels HTML
        let labelsHTML = '<div class="row">';
        
        for (let i = 1; i <= numberOfBags; i++) {
            const qrData = JSON.stringify({
                itemCode: itemCode,
                itemName: itemName,
                quantity: quantity,
                bagNumber: i,
                totalBags: numberOfBags,
                expiryDate: expiryDate || 'N/A',
                warehouse: warehouseCode,
                binLocation: binLocation || 'N/A',
                batchId: batchId,
                timestamp: new Date().toISOString()
            });

            labelsHTML += `
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6 class="card-title">Bag ${i} of ${numberOfBags}</h6>
                            <div id="qr_${i}" class="mb-2"></div>
                            <small class="text-muted">
                                <strong>${itemCode}</strong><br>
                                ${itemName}<br>
                                Qty: ${quantity} | Expiry: ${expiryDate || 'N/A'}<br>
                                Warehouse: ${warehouseCode} | Bin: ${binLocation || 'N/A'}
                            </small>
                        </div>
                    </div>
                </div>
            `;
        }

        labelsHTML += '</div>';

        // Show labels in modal
        document.getElementById('qrLabelsContent').innerHTML = labelsHTML;
        const labelsModal = new bootstrap.Modal(document.getElementById('qrLabelsModal'));
        labelsModal.show();

        // Generate QR codes after modal is shown
        setTimeout(() => {
            for (let i = 1; i <= numberOfBags; i++) {
                const qrData = JSON.stringify({
                    itemCode: itemCode,
                    itemName: itemName,
                    quantity: quantity,
                    bagNumber: i,
                    totalBags: numberOfBags,
                    expiryDate: expiryDate || 'N/A',
                    warehouse: warehouseCode,
                    binLocation: binLocation || 'N/A',
                    batchId: batchId,
                    timestamp: new Date().toISOString()
                });

                new QRCode(document.getElementById(`qr_${i}`), {
                    text: qrData,
                    width: 200,
                    height: 200
                });
            }
        }, 100);
    }

    // Add Manual Item
    function addManualItem() {
        alert('Manual item addition feature coming soon!');
    }

    // Handle form submission
    document.getElementById('addItemForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const data = {
            po_link_id: formData.get('po_link_id'),
            line_selection_id: formData.get('line_selection_id'),
            item_code: formData.get('item_code'),
            item_name: formData.get('item_name'),
            quantity: formData.get('quantity'),
            warehouse_code: formData.get('warehouse_code'),
            bin_location: formData.get('bin_location'),
            expiration_date: formData.get('expiration_date'),
            number_of_bags: formData.get('number_of_bags')
        };

        console.log('Submitting item data:', data);

        fetch(`/multi-grn/api/update-line-item`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('‚úÖ Item details saved successfully!');
                // Update the table row
                document.getElementById(`qty_${currentLineId}`).textContent = data.quantity;
                document.getElementById(`warehouse_${currentLineId}`).textContent = data.warehouse_code;
                document.getElementById(`bin_${currentLineId}`).textContent = data.bin_location || '-';
                document.getElementById(`bags_${currentLineId}`).textContent = data.number_of_bags || '-';
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('addItemModal')).hide();
            } else {
                alert('‚ùå Error: ' + (result.error || 'Failed to save item details'));
            }
        })
        .catch(error => {
            console.error('Error saving item details:', error);
            alert('Network error. Please try again.');
        });
    });

    // Initialize Feather icons
    document.addEventListener('DOMContentLoaded', function() {
        feather.replace();
    });
</script>
{% endblock %}
