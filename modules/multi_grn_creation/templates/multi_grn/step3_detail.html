{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('multi_grn.index') }}">Multiple GRN</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('multi_grn.create_step2_select_pos', batch_id=batch.id) }}">Step 2: POs</a></li>
            <li class="breadcrumb-item active">Step 3: Item Details</li>
        </ol>
    </nav>

    <div class="card">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-0"><i data-feather="package"></i> Step 3: Line Item Details</h4>
                <small>Batch: {{ batch.batch_number }} | Customer: {{ batch.customer_name }}</small>
            </div>
            <div>
                <span class="badge bg-light text-dark">{{ batch.po_links|length }} PO(s) Selected</span>
            </div>
        </div>
        <div class="card-body">
            <!-- Instructions -->
            <div class="alert alert-info">
                <i data-feather="info"></i>
                <strong>Instructions:</strong> For each line item, click "Add Item" to enter warehouse, bin location, batch/serial details, and generate QR labels. Item validation will be performed automatically.
            </div>

            <!-- Purchase Order Items Section -->
            {% for po_link in batch.po_links %}
            {% set pending_lines = [] %}
            {% for line in po_link.line_selections %}
                {% if not line.warehouse_code %}
                    {% set _ = pending_lines.append(line) %}
                {% endif %}
            {% endfor %}
            
            {% if pending_lines %}
            <div class="card mb-4 border-primary">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i data-feather="list"></i> Purchase Order Items - PO #{{ po_link.po_doc_num }}
                    </h5>
                    <small class="text-muted">Vendor: {{ po_link.po_card_name }} ({{ po_link.po_card_code }})</small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Item Code</th>
                                    <th>Description</th>
                                    <th>Ordered</th>
                                    <th>UoM</th>
                                    <th>Price</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for line in pending_lines %}
                                <tr>
                                    <td><strong>{{ line.item_code }}</strong></td>
                                    <td>{{ line.item_description }}</td>
                                    <td>{{ line.ordered_quantity }}</td>
                                    <td>Manual</td>
                                    <td>${{ "%.2f"|format(line.unit_price|float) }}</td>
                                    <td><span class="badge bg-success">Open</span></td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-primary" 
                                                onclick='showAddItemModal({{ line.po_link_id }}, {{ line.id }}, {{ line.po_line_num }}, {{ po_link.po_doc_entry }}, {{ line.item_code|tojson }}, {{ line.item_description|tojson }}, {{ line.selected_quantity }}, {{ line.warehouse_code|tojson }})'>
                                            <i data-feather="plus"></i> Add Item
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}

            <!-- Received Items Section -->
            {% set has_received_items = namespace(value=False) %}
            {% for po_link in batch.po_links %}
                {% for line in po_link.line_selections %}
                    {% if line.warehouse_code %}
                        {% set has_received_items.value = True %}
                    {% endif %}
                {% endfor %}
            {% endfor %}

            {% if has_received_items.value %}
            <div class="card mb-4 border-success">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i data-feather="check-square"></i> Received Items
                    </h5>
                </div>
                <div class="card-body">
                    {% for po_link in batch.po_links %}
                    {% set received_lines = [] %}
                    {% for line in po_link.line_selections %}
                        {% if line.warehouse_code %}
                            {% set _ = received_lines.append(line) %}
                        {% endif %}
                    {% endfor %}
                    
                    {% if received_lines %}
                    <h6 class="text-muted mb-3">PO #{{ po_link.po_doc_num }}</h6>
                    <div class="table-responsive mb-4">
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Line #</th>
                                    <th>Item Code</th>
                                    <th>Description</th>
                                    <th>Qty</th>
                                    <th>Warehouse</th>
                                    <th>Bin Location</th>
                                    <th>Packs</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for line in received_lines %}
                                <tr id="row_{{ line.id }}">
                                    <td><span class="badge bg-secondary">{{ line.po_line_num }}</span></td>
                                    <td><strong>{{ line.item_code }}</strong></td>
                                    <td>{{ line.item_description }}</td>
                                    <td><span id="qty_{{ line.id }}">{{ line.selected_quantity }}</span></td>
                                    <td><span id="warehouse_{{ line.id }}">{{ line.warehouse_code }}</span></td>
                                    <td><span id="bin_{{ line.id }}">{{ line.bin_location or '-' }}</span></td>
                                    <td>
                                        <span id="packs_{{ line.id }}">
                                            {% if line.batch_details %}
                                                {{ line.batch_details[0].no_of_packs if line.batch_details[0].no_of_packs else line.batch_details|length }}
                                            {% elif line.serial_details %}
                                                {{ line.serial_details[0].no_of_packs if line.serial_details[0].no_of_packs else line.serial_details|length }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        {% if line.serial_details %}
                                            <button type="button" class="btn btn-sm btn-primary" 
                                                    onclick="generateSerialQRLabels({{ line.id }}, '{{ line.item_code }}', '{{ line.item_description }}')">
                                                <i data-feather="printer"></i> Print QR Labels
                                            </button>
                                        {% elif line.batch_details %}
                                            <button type="button" class="btn btn-sm btn-info" 
                                                    onclick="generateBatchQRLabels({{ line.id }}, '{{ line.item_code }}', '{{ line.item_description }}')">
                                                <i data-feather="printer"></i> Print QR Labels
                                            </button>
                                        {% else %}
                                            <button type="button" class="btn btn-sm btn-warning" 
                                                    onclick="generateStandardQRLabels({{ line.id }}, '{{ line.item_code }}', '{{ line.item_description }}')">
                                                <i data-feather="printer"></i> Print QR Labels
                                            </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div class="card mb-4 border-secondary">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i data-feather="check-square"></i> Received Items
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i data-feather="info"></i>
                        No items have been received yet. Click "Add Item" to start receiving items from the Purchase Orders above.
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Navigation Buttons -->
            <div class="d-flex justify-content-between mt-4">
                <a href="{{ url_for('multi_grn.create_step2_select_pos', batch_id=batch.id) }}" 
                   class="btn btn-secondary">
                    <i data-feather="arrow-left"></i> Back to Step 2
                </a>
                <div>
                    {% if batch.status == 'draft' or batch.status == 'collecting' %}
                        <button type="button" class="btn btn-success me-2" onclick="submitForQC()">
                            <i data-feather="check-circle"></i> Submit for QC Verification
                        </button>
                    {% elif batch.status == 'pending_qc' %}
                        <span class="badge bg-warning text-dark fs-5 me-2">Pending QC Approval</span>
                        <a href="{{ url_for('multi_grn.view_batch', batch_id=batch.id) }}" class="btn btn-info">
                            View Status <i data-feather="eye"></i>
                        </a>
                    {% elif batch.status == 'qc_approved' %}
                        <span class="badge bg-success fs-5 me-2">QC Approved</span>
                        <a href="{{ url_for('multi_grn.create_step4_review', batch_id=batch.id) }}" class="btn btn-primary">
                            Review & Post to SAP <i data-feather="arrow-right"></i>
                        </a>
                    {% elif batch.status == 'qc_rejected' %}
                        <div class="alert alert-danger">
                            <strong><i data-feather="x-circle"></i> QC Rejected</strong>
                            <p class="mb-2">Reason: {{ batch.qc_notes }}</p>
                            <button type="button" class="btn btn-warning" onclick="resetForResubmission()">
                                <i data-feather="refresh-cw"></i> Reset & Resubmit
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i data-feather="package"></i> Line Item Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="addItemForm">
                <div class="modal-body">
                    <!-- PO Reference Information -->
                    <div class="alert alert-info">
                        <strong>PO Reference:</strong> 
                        PO Line: <span id="display_po_line"></span> | 
                        BaseEntry: <span id="display_base_entry"></span>
                    </div>

                    <!-- Item Code and Name (Auto-validated) -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="item_code" class="form-label">Item Code <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="item_code" name="item_code" readonly required>
                                <span id="item_validation_status" class="form-text"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="item_name" class="form-label">Item Name</label>
                                <input type="text" class="form-control" id="item_name" name="item_name" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Quantity and Management Type -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="quantity" class="form-label">Quantity <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="quantity" name="quantity" step="0.001" required readonly>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="management_type" class="form-label">Management Type</label>
                                <input type="text" class="form-control" id="management_type" name="management_type" readonly>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="unit_of_measure" class="form-label">UoM</label>
                                <input type="text" class="form-control" id="unit_of_measure" name="unit_of_measure" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Warehouse and Bin Location (Auto-fill from PO) -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="warehouse_code" class="form-label">Warehouse <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="warehouse_code" name="warehouse_code" required>
                                <small class="form-text text-muted">Auto-filled from PO line item</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="bin_location" class="form-label">Bin Location</label>
                                <select class="form-select" id="bin_location" name="bin_location">
                                    <option value="">Select bin location...</option>
                                </select>
                                <small class="form-text text-muted">Loaded based on warehouse selection</small>
                            </div>
                        </div>
                    </div>

                    <!-- Standard Item Section (Non-Batch, Non-Serial) -->
                    <div id="standard_item_section" style="display: none;">
                        <hr>
                        <h6 class="text-muted"><i data-feather="package"></i> Standard Item Details</h6>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="standard_expiration_date" class="form-label">Expiration Date (Optional)</label>
                                    <input type="date" class="form-control" id="standard_expiration_date" name="standard_expiration_date">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="standard_number_of_bags" class="form-label">Number of Bags</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="standard_number_of_bags" name="number_of_bags_standard"
                                               placeholder="Enter number of bags for label printing" min="1" max="1000" value="1">
                                        <button class="btn btn-success" type="button" onclick="generateStandardLabelsFromModal()" 
                                                title="Generate barcode labels for bags">
                                            <i data-feather="printer"></i> Generate Labels
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">Enter the number of bags to generate QR labels (e.g., 5 will generate labels 1 of 5, 2 of 5, etc.)</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Batch Section (Batch Managed Items) -->
                    <div id="batch_section" style="display: none;">
                        <hr>
                        <h6 class="text-primary"><i data-feather="layers"></i> Batch Details</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="batch_number" class="form-label">Batch Number <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="batch_number" name="batch_number"
                                           placeholder="Enter batch number">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="expiration_date" class="form-label">Expiration Date</label>
                                    <input type="date" class="form-control" id="expiration_date" name="expiration_date">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="number_of_bags" class="form-label">Number of Bags</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="number_of_bags" name="number_of_bags_batch"
                                               placeholder="Enter number of bags for label printing" min="1" max="1000" value="1">
                                        <button class="btn btn-success" type="button" onclick="generateBatchLabelsFromModal()" 
                                                title="Generate barcode labels for bags">
                                            <i data-feather="printer"></i> Generate Labels
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">Enter the number of bags to generate barcode labels (e.g., 10 will generate labels 1 of 10, 2 of 10, etc.)</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Serial Number Section (Serial Managed Items) -->
                    <div id="serial_section" style="display: none;">
                        <hr>
                        <h6 class="text-info"><i data-feather="hash"></i> Serial Number Details</h6>
                        <div class="mb-3">
                            <label class="form-label">
                                Serial Numbers 
                                <span class="badge bg-info">Required for Serial Managed Items</span>
                            </label>
                            <div id="serial_numbers_container" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                <!-- Serial number inputs will be dynamically generated here -->
                            </div>
                            <input type="hidden" id="serial_numbers_json" name="serial_numbers_json">
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="serial_number_of_bags" class="form-label">Number of Bags</label>
                                    <input type="number" class="form-control" id="serial_number_of_bags" name="number_of_bags_serials"
                                           placeholder="Enter number of bags for label printing" min="1" max="1000" value="1">
                                    <small class="form-text text-muted">Enter the number of bags to generate barcode labels (e.g., if you have 100 serials and enter 5, each bag will contain 20 serials)</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden fields -->
                    <input type="hidden" id="po_link_id" name="po_link_id">
                    <input type="hidden" id="line_selection_id" name="line_selection_id">
                    <input type="hidden" id="po_line_num" name="po_line_num">
                    <input type="hidden" id="base_entry" name="base_entry">
                    <input type="hidden" id="batch_id" name="batch_id" value="{{ batch.id }}">
                    <input type="hidden" id="batch_required" name="batch_required" value="N">
                    <input type="hidden" id="serial_required" name="serial_required" value="N">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">
                        <i data-feather="save"></i> Save Details
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- QR Labels Modal -->
<div class="modal fade" id="serialQRLabelsModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i data-feather="printer"></i> QR Code Labels</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="serialQRLabelsContainer" class="row">
                    <!-- QR Labels will be generated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="printAllQRLabels()">
                    <i data-feather="printer"></i> Print All Labels
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
    let currentLineId = null;
    let currentPoLinkId = null;
    let currentItemCode = null;
    let currentItemManagementType = null;

    // Show Add Item Modal with PO line details
    function showAddItemModal(poLinkId, lineId, poLineNum, baseEntry, itemCode, itemName, quantity, warehouseCode) {
        currentLineId = lineId;
        currentPoLinkId = poLinkId;
        currentItemCode = itemCode;

        // Populate PO reference information
        document.getElementById('display_po_line').textContent = poLineNum;
        document.getElementById('display_base_entry').textContent = baseEntry;

        // Populate form fields
        document.getElementById('po_link_id').value = poLinkId;
        document.getElementById('line_selection_id').value = lineId;
        document.getElementById('po_line_num').value = poLineNum;
        document.getElementById('base_entry').value = baseEntry;
        document.getElementById('item_code').value = itemCode;
        document.getElementById('item_name').value = itemName;
        document.getElementById('quantity').value = quantity;
        document.getElementById('warehouse_code').value = warehouseCode || '7000-FG';
        document.getElementById('number_of_packs').value = 1;

        // Auto-validate item code
        validateItemCode(itemCode);

        // Load bin locations for the warehouse
        if (warehouseCode) {
            loadBinLocations(warehouseCode);
        }

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('addItemModal'));
        modal.show();
    }

    // Validate Item Code (Same as GRPO Module)
    function validateItemCode(itemCode) {
        if (!itemCode) return;

        const statusSpan = document.getElementById('item_validation_status');
        statusSpan.innerHTML = '<span class="text-info"><i data-feather="loader"></i> Validating...</span>';
        feather.replace();

        fetch(`/multi-grn/validate-item/${encodeURIComponent(itemCode)}`)
            .then(response => response.json())
            .then(data => {
                console.log('✅ Validation result:', data);

                if (data.success) {
                    statusSpan.innerHTML = '<span class="text-success">✓ Item validated</span>';
                    
                    // Set management type
                    let managementType = 'Standard';
                    if (data.serial_required) {
                        managementType = 'Serial Managed';
                        document.getElementById('batch_required').value = 'N';
                        document.getElementById('serial_required').value = 'Y';
                    } else if (data.batch_required) {
                        managementType = 'Batch Managed';
                        document.getElementById('batch_required').value = 'Y';
                        document.getElementById('serial_required').value = 'N';
                    } else {
                        document.getElementById('batch_required').value = 'N';
                        document.getElementById('serial_required').value = 'N';
                    }
                    
                    document.getElementById('management_type').value = managementType;
                    currentItemManagementType = managementType;
                    
                    if (data.uom) {
                        document.getElementById('unit_of_measure').value = data.uom;
                    }
                    
                    // Show/hide appropriate section based on management type
                    document.getElementById('standard_item_section').style.display = 'none';
                    document.getElementById('batch_section').style.display = 'none';
                    document.getElementById('serial_section').style.display = 'none';
                    
                    if (data.serial_required) {
                        document.getElementById('serial_section').style.display = 'block';
                        generateSerialInputs(parseInt(document.getElementById('quantity').value) || 1);
                    } else if (data.batch_required) {
                        document.getElementById('batch_section').style.display = 'block';
                    } else {
                        document.getElementById('standard_item_section').style.display = 'block';
                    }
                } else {
                    statusSpan.innerHTML = '<span class="text-danger">⚠ Validation failed</span>';
                    alert('⚠️ Item validation failed: ' + (data.error || 'Unknown error'));
                }
                
                feather.replace();
            })
            .catch(error => {
                console.error('❌ Error validating item:', error);
                statusSpan.innerHTML = '<span class="text-danger">⚠ Error validating</span>';
                feather.replace();
            });
    }

    // Load Bin Locations based on Warehouse (Same as GRPO Module)
    function loadBinLocations(warehouseCode) {
        const binSelect = document.getElementById('bin_location');
        binSelect.innerHTML = '<option value="">Loading bins...</option>';

        fetch(`/multi-grn/api/get-bins?warehouse=${encodeURIComponent(warehouseCode)}`)
            .then(response => response.json())
            .then(data => {
                binSelect.innerHTML = '<option value="">Select bin location...</option>';
                
                if (data.success && data.bins && data.bins.length > 0) {
                    data.bins.forEach(bin => {
                        const option = document.createElement('option');
                        option.value = bin.BinCode || bin.AbsEntry;
                        option.textContent = bin.BinCode || 'N/A';
                        binSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No bins available';
                    binSelect.appendChild(option);
                }
            })
            .catch(error => {
                console.error('Error loading bins:', error);
                binSelect.innerHTML = '<option value="">Error loading bins</option>';
            });
    }

    // Reload bin locations when warehouse changes
    document.addEventListener('DOMContentLoaded', function() {
        const warehouseInput = document.getElementById('warehouse_code');
        if (warehouseInput) {
            warehouseInput.addEventListener('change', function() {
                const warehouseCode = this.value;
                if (warehouseCode) {
                    loadBinLocations(warehouseCode);
                }
            });
        }
    });

    // Generate Serial Number Inputs
    function generateSerialInputs(quantity) {
        const container = document.getElementById('serial_numbers_container');
        container.innerHTML = '';
        
        for (let i = 0; i < quantity; i++) {
            const serialDiv = document.createElement('div');
            serialDiv.className = 'row mb-2';
            serialDiv.innerHTML = `
                <div class="col-md-1">
                    <strong>#${i + 1}</strong>
                </div>
                <div class="col-md-5">
                    <input type="text" class="form-control form-control-sm serial-mfr-input" 
                           placeholder="Manufacturer Serial" required>
                </div>
                <div class="col-md-5">
                    <input type="text" class="form-control form-control-sm serial-int-input" 
                           placeholder="Internal Serial" required>
                </div>
            `;
            container.appendChild(serialDiv);
        }
        
        // Add Generate Labels button after serial inputs
        const buttonDiv = document.createElement('div');
        buttonDiv.className = 'row mt-3';
        buttonDiv.innerHTML = `
            <div class="col-md-12">
                <button type="button" class="btn btn-success w-100" onclick="generateSerialLabelsFromModal()">
                    <i data-feather="printer"></i> Generate Serial Labels
                </button>
            </div>
        `;
        container.appendChild(buttonDiv);
        feather.replace();
    }

    // Generate Serial Labels from Modal
    function generateSerialLabelsFromModal() {
        const lineSelectionId = document.getElementById('line_selection_id').value;
        const numberOfBags = parseInt(document.getElementById('serial_number_of_bags').value);
        const mfrInputs = document.querySelectorAll('.serial-mfr-input');
        const intInputs = document.querySelectorAll('.serial-int-input');
        
        if (!numberOfBags || numberOfBags < 1) {
            alert('⚠️ Please enter a valid number of bags (minimum 1)');
            return;
        }
        
        // Collect and validate serial numbers
        const serialNumbers = [];
        for (let i = 0; i < mfrInputs.length; i++) {
            const mfr = mfrInputs[i].value.trim();
            const int = intInputs[i].value.trim();
            
            if (!mfr || !int) {
                alert(`⚠️ Please fill in all serial numbers (row ${i + 1})`);
                return;
            }
            
            serialNumbers.push({
                serial_number: int,
                manufacturer_serial_number: mfr,
                internal_serial_number: int,
                no_of_packs: numberOfBags,
                qty_per_pack: 1
            });
        }
        
        // Save all serial numbers first
        let savedCount = 0;
        const savePromises = serialNumbers.map(serial => {
            return fetch(`/multi-grn/api/line-selections/${lineSelectionId}/serial-details`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(serial)
            })
            .then(response => response.json())
            .then(result => {
                if (!result.success) {
                    throw new Error(result.error || 'Failed to save serial');
                }
                savedCount++;
                return result;
            });
        });
        
        // Wait for all serials to be saved
        Promise.all(savePromises)
            .then(() => {
                console.log(`✅ Saved ${savedCount} serial numbers, generating QR labels...`);
                // Now generate QR labels
                return fetch('/multi-grn/api/generate-barcode-labels', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        batch_id: document.getElementById('batch_id').value,
                        line_selection_id: lineSelectionId,
                        label_type: 'serial'
                    })
                });
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to generate labels');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    displayQRLabels(data.labels);
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            });
    }

    // Generate Batch Labels from Modal
    function generateBatchLabelsFromModal() {
        const lineSelectionId = document.getElementById('line_selection_id').value;
        const batchNumber = document.getElementById('batch_number').value.trim();
        const expirationDate = document.getElementById('expiration_date').value;
        const numberOfBags = parseInt(document.getElementById('number_of_bags').value);
        const quantity = parseFloat(document.getElementById('quantity').value);
        
        if (!batchNumber) {
            alert('⚠️ Please enter a batch number');
            return;
        }
        
        if (!numberOfBags || numberOfBags < 1) {
            alert('⚠️ Please enter a valid number of bags (minimum 1)');
            return;
        }
        
        if (!quantity || quantity <= 0) {
            alert('⚠️ Invalid quantity');
            return;
        }
        
        // First save the batch details
        const batchData = {
            batch_number: batchNumber,
            quantity: quantity,
            expiry_date: expirationDate || null,
            no_of_packs: numberOfBags,
            qty_per_pack: quantity / numberOfBags
        };
        
        fetch(`/multi-grn/api/line-selections/${lineSelectionId}/batch-details`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(batchData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to save batch details');
            }
            return response.json();
        })
        .then(result => {
            if (!result.success) {
                throw new Error(result.error || 'Failed to save batch details');
            }
            console.log('✅ Batch details saved, generating QR labels...');
            // Now generate QR labels using the server-side API
            return fetch('/multi-grn/api/generate-barcode-labels', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    batch_id: document.getElementById('batch_id').value,
                    line_selection_id: lineSelectionId,
                    label_type: 'batch'
                })
            });
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to generate labels');
            }
            return response.json();
        })
        .then(data => {
            if (!data.success) {
                throw new Error(data.error || 'Unknown error');
            }
            displayQRLabels(data.labels);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error: ' + error.message);
        });
    }

    // Generate Standard Labels from Modal
    function generateStandardLabelsFromModal() {
        const lineSelectionId = document.getElementById('line_selection_id').value;
        const batchId = document.getElementById('batch_id').value;
        const numberOfBags = parseInt(document.getElementById('standard_number_of_bags').value);
        const expirationDate = document.getElementById('standard_expiration_date').value;
        const quantity = parseFloat(document.getElementById('quantity').value);
        
        if (!numberOfBags || numberOfBags < 1) {
            alert('⚠️ Please enter a valid number of bags (minimum 1)');
            return;
        }
        
        if (!quantity || quantity <= 0) {
            alert('⚠️ Invalid quantity');
            return;
        }
        
        // First save non-managed details for each pack
        const savePromises = [];
        for (let packNum = 1; packNum <= numberOfBags; packNum++) {
            const packData = {
                quantity: quantity / numberOfBags,
                qty_per_pack: quantity / numberOfBags,
                no_of_packs: numberOfBags,
                pack_number: packNum,
                expiry_date: expirationDate || null
            };
            
            savePromises.push(
                fetch(`/multi-grn/api/line-selections/${lineSelectionId}/non-managed-details`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(packData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to save pack details');
                    }
                    return response.json();
                })
                .then(result => {
                    if (!result.success) {
                        throw new Error(result.error || 'Failed to save pack details');
                    }
                    return result;
                })
            );
        }
        
        // Wait for all packs to be saved
        Promise.all(savePromises)
            .then(() => {
                console.log(`✅ Saved ${numberOfBags} pack(s), generating QR labels...`);
                // Now generate QR labels
                return fetch('/multi-grn/api/generate-barcode-labels', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        batch_id: batchId,
                        line_selection_id: lineSelectionId,
                        label_type: 'regular'
                    })
                });
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to generate labels');
                }
                return response.json();
            })
            .then(data => {
                if (!data.success) {
                    throw new Error(data.error || 'Unknown error');
                }
                displayQRLabels(data.labels);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            });
    }

    // Generate QR Labels (Serial, Batch, or Standard items)
    function generateQRLabels() {
        const lineSelectionId = document.getElementById('line_selection_id').value;
        const batchId = document.getElementById('batch_id').value;
        const numberOfPacks = parseInt(document.getElementById('number_of_packs').value);
        const batchRequired = document.getElementById('batch_required').value;
        const serialRequired = document.getElementById('serial_required').value;

        if (!lineSelectionId || !batchId) {
            alert('Missing required data for QR generation');
            return;
        }

        if (!numberOfPacks || numberOfPacks < 1) {
            alert('Please enter a valid number of packs (minimum 1)');
            return;
        }

        // Determine label type based on management
        let labelType = 'regular';
        if (serialRequired === 'Y') {
            labelType = 'serial';
        } else if (batchRequired === 'Y') {
            labelType = 'batch';
        }

        // Call API to generate barcode labels
        fetch('/multi-grn/api/generate-barcode-labels', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                batch_id: batchId,
                line_selection_id: lineSelectionId,
                label_type: labelType
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayQRLabels(data.labels);
            } else {
                alert('Error generating QR labels: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error generating QR labels:', error);
            alert('Network error generating QR labels');
        });
    }

    // Display QR Labels in Modal
    function displayQRLabels(labels) {
        const content = document.getElementById('serialQRLabelsContainer');
        let html = '<div class="row">';

        labels.forEach((label, index) => {
            html += `
                <div class="col-md-6 mb-4">
                    <div class="card border-dark">
                        <div class="card-body">
                            <h5 class="card-title text-center">Pack ${label.sequence} of ${label.total}</h5>
                            <div class="text-center mb-3">
                                ${label.qr_code_image ? `<img src="${label.qr_code_image}" alt="QR Code" style="max-width: 250px;">` : '<p class="text-muted">QR Code generation failed</p>'}
                            </div>
                            <table class="table table-sm table-bordered">
                                <tr>
                                    <th>PO Number:</th>
                                    <td>${label.po_number}</td>
                                </tr>
                                <tr>
                                    <th>Item Code:</th>
                                    <td>${label.item_code}</td>
                                </tr>
                                <tr>
                                    <th>Item Name:</th>
                                    <td>${label.item_name}</td>
                                </tr>
                                ${label.batch_number ? `<tr><th>Batch:</th><td>${label.batch_number}</td></tr>` : ''}
                                ${label.serial_number ? `<tr><th>Serial:</th><td>${label.serial_number}</td></tr>` : ''}
                                <tr>
                                    <th>Quantity:</th>
                                    <td>${label.quantity}</td>
                                </tr>
                                <tr>
                                    <th>GRN Date:</th>
                                    <td>${label.grn_date}</td>
                                </tr>
                                <tr>
                                    <th>Expiry Date:</th>
                                    <td>${label.expiration_date}</td>
                                </tr>
                                <tr>
                                    <th>GRN Number:</th>
                                    <td>${label.grn_number}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        content.innerHTML = html;

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('serialQRLabelsModal'));
        modal.show();
    }

    // Handle form submission - Enhanced to save batch/serial/standard details
    document.getElementById('addItemForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const lineSelectionId = formData.get('line_selection_id');
        const quantity = parseFloat(formData.get('quantity'));
        const warehouseCode = formData.get('warehouse_code');
        const binLocation = formData.get('bin_location');
        const batchRequired = formData.get('batch_required');
        const serialRequired = formData.get('serial_required');

        console.log('Saving line item details - Management type:', { batchRequired, serialRequired });

        try {
            // Step 1: Save basic line item details (warehouse, bin, quantity)
            const baseData = {
                line_selection_id: lineSelectionId,
                quantity: quantity,
                warehouse_code: warehouseCode,
                bin_location: binLocation
            };

            let baseResponse = await fetch('/multi-grn/api/update-line-item', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(baseData)
            });

            let baseResult = await baseResponse.json();
            if (!baseResult.success) {
                throw new Error(baseResult.error || 'Failed to save basic details');
            }

            // Step 2: Save management-specific details (batch/serial/standard)
            if (serialRequired === 'Y') {
                // Save serial numbers
                const mfrInputs = document.querySelectorAll('.serial-mfr-input');
                const intInputs = document.querySelectorAll('.serial-int-input');
                const numberOfBags = parseInt(document.getElementById('serial_number_of_bags').value) || 1;

                const serialNumbers = [];
                for (let i = 0; i < mfrInputs.length; i++) {
                    const mfr = mfrInputs[i].value.trim();
                    const int = intInputs[i].value.trim();

                    if (!mfr || !int) {
                        throw new Error(`Please fill in all serial numbers (row ${i + 1})`);
                    }

                    serialNumbers.push({
                        serial_number: int,
                        manufacturer_serial_number: mfr,
                        internal_serial_number: int,
                        no_of_packs: numberOfBags,
                        qty_per_pack: 1
                    });
                }

                // Save each serial number
                for (const serial of serialNumbers) {
                    const serialResponse = await fetch(`/multi-grn/api/line-selections/${lineSelectionId}/serial-details`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(serial)
                    });

                    const serialResult = await serialResponse.json();
                    if (!serialResult.success) {
                        throw new Error(serialResult.error || 'Failed to save serial number');
                    }
                }

                console.log(`✅ Saved ${serialNumbers.length} serial numbers`);

            } else if (batchRequired === 'Y') {
                // Save batch details
                const batchNumber = document.getElementById('batch_number').value.trim();
                const expirationDate = document.getElementById('expiration_date').value;
                const numberOfBags = parseInt(document.getElementById('number_of_bags').value) || 1;

                if (!batchNumber) {
                    throw new Error('Please enter a batch number');
                }

                const batchData = {
                    batch_number: batchNumber,
                    quantity: quantity,
                    expiry_date: expirationDate || null,
                    no_of_packs: numberOfBags,
                    qty_per_pack: quantity / numberOfBags
                };

                const batchResponse = await fetch(`/multi-grn/api/line-selections/${lineSelectionId}/batch-details`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(batchData)
                });

                const batchResult = await batchResponse.json();
                if (!batchResult.success) {
                    throw new Error(batchResult.error || 'Failed to save batch details');
                }

                console.log(`✅ Saved batch details: ${batchNumber}`);

            } else {
                // Save standard/non-managed item details
                const numberOfBags = parseInt(document.getElementById('standard_number_of_bags').value) || 1;
                const expirationDate = document.getElementById('standard_expiration_date').value;

                // Save non-managed details for each pack
                for (let packNum = 1; packNum <= numberOfBags; packNum++) {
                    const packData = {
                        quantity: quantity / numberOfBags,
                        qty_per_pack: quantity / numberOfBags,
                        no_of_packs: numberOfBags,
                        pack_number: packNum,
                        expiry_date: expirationDate || null
                    };

                    const packResponse = await fetch(`/multi-grn/api/line-selections/${lineSelectionId}/non-managed-details`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(packData)
                    });

                    const packResult = await packResponse.json();
                    if (!packResult.success) {
                        throw new Error(packResult.error || 'Failed to save pack details');
                    }
                }

                console.log(`✅ Saved ${numberOfBags} pack(s) for standard item`);
            }

            // Success - close modal and reload
            alert('✅ Item details saved successfully!');
            bootstrap.Modal.getInstance(document.getElementById('addItemModal')).hide();
            setTimeout(() => location.reload(), 500);

        } catch (error) {
            console.error('Error saving details:', error);
            alert('❌ Error: ' + error.message);
        }
    });

    // Helper function to wait for QRCode library to load
    function waitForQRCode(callback) {
        if (typeof QRCode !== 'undefined') {
            callback(true);
        } else {
            console.log('⏳ Waiting for QRCode library...');
            setTimeout(() => waitForQRCode(callback), 100);
        }
    }

    // Generate Serial QR Labels for Multi GRN
    function generateSerialQRLabels(lineId, itemCode, itemName) {
        fetch(`/multi-grn/api/line-selections/${lineId}/serial-details`, {
            credentials: 'same-origin'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (!data.success || !data.serial_details || data.serial_details.length === 0) {
                    alert('No serial numbers found for this item');
                    return;
                }

                const serialNumbers = data.serial_details;
                const lineDetails = data.line_details || {};
                const modal = new bootstrap.Modal(document.getElementById('serialQRLabelsModal'));
                const container = document.getElementById('serialQRLabelsContainer');
                container.innerHTML = '';

                // Wait for QRCode library then generate codes
                waitForQRCode((loaded) => {
                    let totalLabelsGenerated = 0;
                    
                    serialNumbers.forEach((serial, serialIndex) => {
                        const qtyPerPack = serial.qty_per_pack || 1;
                        const numberOfPacks = serial.no_of_packs || 1;
                        
                        // Generate one QR code per pack based on no_of_packs
                        for (let packNum = 1; packNum <= numberOfPacks; packNum++) {
                            totalLabelsGenerated++;
                            
                            // Generate comprehensive QR data with all requested fields in JSON format
                            const qrDataObj = {
                                'id': lineDetails.batch_number || 'Multi-GRN',
                                'po': lineDetails.po_doc_num || 'N/A',
                                'item': itemCode,
                                'SerialNumber': serial.internal_serial_number || serial.serial_number,
                                'qty': qtyPerPack,
                                'pack': `${packNum} of ${numberOfPacks}`,
                                'grn_date': new Date().toISOString().split('T')[0],
                                'exp_date': serial.expiry_date || 'N/A'
                            };
                            
                            // Convert to JSON format for QR code
                            const qrData = JSON.stringify(qrDataObj);

                            const qrDiv = document.createElement('div');
                            qrDiv.className = 'qr-label-item col-md-4 mb-3';
                            
                            const labelCard = document.createElement('div');
                            labelCard.className = 'card border-primary';
                            labelCard.style.pageBreakInside = 'avoid';
                            
                            labelCard.innerHTML = `
                                <div class="card-body text-center">
                                    <h6 class="card-title">${itemCode}</h6>
                                    <p class="card-text text-muted small mb-2">${itemName}</p>
                                    <div id="qr_serial_${serialIndex}_${packNum}" class="mx-auto" style="width: 200px; height: 200px;"></div>
                                    <div class="mt-2">
                                        <strong>Serial:</strong> ${serial.internal_serial_number || serial.serial_number}<br>
                                        <strong>Pack:</strong> ${packNum} of ${numberOfPacks}<br>
                                        <strong>Qty/Pack:</strong> ${qtyPerPack}
                                        ${serial.expiry_date ? `<br><strong>Expiry:</strong> ${serial.expiry_date}` : ''}
                                    </div>
                                </div>
                            `;
                            
                            qrDiv.appendChild(labelCard);
                            container.appendChild(qrDiv);
                            
                            // Generate QR code
                            new QRCode(document.getElementById(`qr_serial_${serialIndex}_${packNum}`), {
                                text: qrData,
                                width: 200,
                                height: 200,
                                correctLevel: QRCode.CorrectLevel.M
                            });
                        }
                    });
                    
                    console.log(`✅ Generated ${totalLabelsGenerated} serial QR labels for ${itemCode}`);
                });

                modal.show();
            })
            .catch(error => {
                console.error('Error fetching serial numbers:', error);
                alert(`Error loading serial numbers: ${error.message}`);
            });
    }

    // Generate Batch QR Labels for Multi GRN
    function generateBatchQRLabels(lineId, itemCode, itemName) {
        fetch(`/multi-grn/api/line-selections/${lineId}/batch-details`, {
            credentials: 'same-origin'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (!data.success || !data.batch_details || data.batch_details.length === 0) {
                    alert('No batch numbers found for this item');
                    return;
                }

                const batchNumbers = data.batch_details;
                const lineDetails = data.line_details || {};
                const modal = new bootstrap.Modal(document.getElementById('serialQRLabelsModal'));
                const container = document.getElementById('serialQRLabelsContainer');
                container.innerHTML = '';

                let totalLabelsGenerated = 0;

                // Wait for QRCode library then generate codes
                waitForQRCode((loaded) => {
                    batchNumbers.forEach((batch, batchIndex) => {
                        const receivedQty = Math.floor(batch.quantity);
                        const numberOfPacks = batch.no_of_packs || 1;
                        const qtyPerPack = batch.qty_per_pack || receivedQty;

                        // Generate one QR code per pack based on no_of_packs
                        for (let packNum = 1; packNum <= numberOfPacks; packNum++) {
                            totalLabelsGenerated++;

                            // Comprehensive QR data with all required fields in JSON format
                            const qrDataObj = {
                                'id': lineDetails.batch_number || 'Multi-GRN',
                                'po': lineDetails.po_doc_num || 'N/A',
                                'item': itemCode,
                                'batch': batch.batch_number,
                                'qty': qtyPerPack,
                                'pack': `${packNum} of ${numberOfPacks}`,
                                'grn_date': new Date().toISOString().split('T')[0],
                                'exp_date': batch.expiry_date || 'N/A'
                            };
                            
                            // Convert to JSON format for QR code
                            const qrData = JSON.stringify(qrDataObj);

                            const qrDiv = document.createElement('div');
                            qrDiv.className = 'qr-label-item col-md-4 mb-3';
                            
                            const labelCard = document.createElement('div');
                            labelCard.className = 'card border-info';
                            labelCard.style.pageBreakInside = 'avoid';
                            
                            labelCard.innerHTML = `
                                <div class="card-body text-center">
                                    <h6 class="card-title">${itemCode}</h6>
                                    <p class="card-text text-muted small mb-2">${itemName}</p>
                                    <div id="qr_batch_${batchIndex}_${packNum}" class="mx-auto" style="width: 200px; height: 200px;"></div>
                                    <div class="mt-2">
                                        <strong>Batch:</strong> ${batch.batch_number}<br>
                                        <strong>Pack:</strong> ${packNum} of ${numberOfPacks}<br>
                                        <strong>Qty/Pack:</strong> ${qtyPerPack}
                                        ${batch.expiry_date ? `<br><strong>Expiry:</strong> ${batch.expiry_date}` : ''}
                                    </div>
                                </div>
                            `;
                            
                            qrDiv.appendChild(labelCard);
                            container.appendChild(qrDiv);
                            
                            // Generate QR code
                            new QRCode(document.getElementById(`qr_batch_${batchIndex}_${packNum}`), {
                                text: qrData,
                                width: 200,
                                height: 200,
                                correctLevel: QRCode.CorrectLevel.M
                            });
                        }
                    });
                    
                    console.log(`✅ Generated ${totalLabelsGenerated} batch QR labels for ${itemCode}`);
                });

                modal.show();
            })
            .catch(error => {
                console.error('Error fetching batch numbers:', error);
                alert(`Error loading batch numbers: ${error.message}`);
            });
    }

    // Generate Standard/Non-Managed QR Labels for Multi GRN
    function generateStandardQRLabels(lineId, itemCode, itemName) {
        // Fetch line details to get quantity and warehouse info
        fetch(`/multi-grn/api/line-selections/${lineId}/details`, {
            credentials: 'same-origin'
        })
            .then(response => {
                if (!response.ok) {
                    // If dedicated endpoint doesn't exist, use the line selection data directly
                    return fetch(`/multi-grn/api/update-line-item?line_id=${lineId}`, {
                        credentials: 'same-origin'
                    });
                }
                return response;
            })
            .then(response => response.json())
            .then(data => {
                // Use line data to generate QR labels
                const lineDetails = data.line_details || data;
                const quantity = lineDetails.selected_quantity || 1;
                const numberOfPacks = lineDetails.number_of_packs || 1;
                const qtyPerPack = quantity / numberOfPacks;

                const modal = new bootstrap.Modal(document.getElementById('serialQRLabelsModal'));
                const container = document.getElementById('serialQRLabelsContainer');
                container.innerHTML = '';

                // Wait for QRCode library then generate codes
                waitForQRCode((loaded) => {
                    // Generate one QR code per pack
                    for (let packNum = 1; packNum <= numberOfPacks; packNum++) {
                        // Comprehensive QR data
                        const qrDataObj = {
                            'id': lineDetails.batch_number || 'Multi-GRN',
                            'po': lineDetails.po_doc_num || 'N/A',
                            'item': itemCode,
                            'qty': qtyPerPack.toFixed(3),
                            'pack': `${packNum} of ${numberOfPacks}`,
                            'warehouse': lineDetails.warehouse_code || 'N/A',
                            'bin': lineDetails.bin_location || 'N/A',
                            'grn_date': new Date().toISOString().split('T')[0]
                        };
                        
                        // Convert to JSON format for QR code
                        const qrData = JSON.stringify(qrDataObj);

                        const qrDiv = document.createElement('div');
                        qrDiv.className = 'qr-label-item col-md-4 mb-3';
                        
                        const labelCard = document.createElement('div');
                        labelCard.className = 'card border-warning';
                        labelCard.style.pageBreakInside = 'avoid';
                        
                        labelCard.innerHTML = `
                            <div class="card-body text-center">
                                <h6 class="card-title">${itemCode}</h6>
                                <p class="card-text text-muted small mb-2">${itemName}</p>
                                <div id="qr_standard_${packNum}" class="mx-auto" style="width: 200px; height: 200px;"></div>
                                <div class="mt-2">
                                    <strong>Pack:</strong> ${packNum} of ${numberOfPacks}<br>
                                    <strong>Qty/Pack:</strong> ${qtyPerPack.toFixed(3)}<br>
                                    <strong>Warehouse:</strong> ${lineDetails.warehouse_code || 'N/A'}<br>
                                    <strong>Bin:</strong> ${lineDetails.bin_location || 'N/A'}
                                </div>
                            </div>
                        `;
                        
                        qrDiv.appendChild(labelCard);
                        container.appendChild(qrDiv);
                        
                        // Generate QR code
                        new QRCode(document.getElementById(`qr_standard_${packNum}`), {
                            text: qrData,
                            width: 200,
                            height: 200,
                            correctLevel: QRCode.CorrectLevel.M
                        });
                    }
                    
                    console.log(`✅ Generated ${numberOfPacks} standard QR labels for ${itemCode}`);
                });

                modal.show();
            })
            .catch(error => {
                console.error('Error generating standard QR labels:', error);
                
                // Fallback: generate basic QR labels using line ID
                const modal = new bootstrap.Modal(document.getElementById('serialQRLabelsModal'));
                const container = document.getElementById('serialQRLabelsContainer');
                container.innerHTML = '';
                
                waitForQRCode((loaded) => {
                    const qrDataObj = {
                        'item': itemCode,
                        'line_id': lineId,
                        'grn_date': new Date().toISOString().split('T')[0]
                    };
                    
                    const qrData = JSON.stringify(qrDataObj);
                    
                    const qrDiv = document.createElement('div');
                    qrDiv.className = 'qr-label-item col-md-4 mb-3';
                    
                    const labelCard = document.createElement('div');
                    labelCard.className = 'card border-warning';
                    labelCard.innerHTML = `
                        <div class="card-body text-center">
                            <h6 class="card-title">${itemCode}</h6>
                            <p class="card-text text-muted small mb-2">${itemName}</p>
                            <div id="qr_standard_fallback" class="mx-auto" style="width: 200px; height: 200px;"></div>
                            <div class="mt-2">
                                <strong>Line ID:</strong> ${lineId}<br>
                                <strong>Date:</strong> ${new Date().toLocaleDateString()}
                            </div>
                        </div>
                    `;
                    
                    qrDiv.appendChild(labelCard);
                    container.appendChild(qrDiv);
                    
                    new QRCode(document.getElementById('qr_standard_fallback'), {
                        text: qrData,
                        width: 200,
                        height: 200,
                        correctLevel: QRCode.CorrectLevel.M
                    });
                });
                
                modal.show();
            });
    }

    // Print all QR labels
    function printAllQRLabels() {
        const container = document.getElementById('serialQRLabelsContainer');
        const printWindow = window.open('', '_blank', 'width=800,height=600');

        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Print QR Labels</title>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                        margin: 0;
                        padding: 20px;
                    }
                    .qr-label-item {
                        display: inline-block;
                        width: 30%;
                        margin: 1%;
                        page-break-inside: avoid;
                        vertical-align: top;
                    }
                    .card {
                        border: 2px solid #0066cc;
                        padding: 15px;
                        text-align: center;
                        margin-bottom: 20px;
                    }
                    .card-title {
                        font-size: 16px;
                        font-weight: bold;
                        margin-bottom: 5px;
                    }
                    .card-text {
                        font-size: 12px;
                        color: #666;
                        margin-bottom: 10px;
                    }
                    @media print {
                        .qr-label-item {
                            page-break-inside: avoid;
                        }
                    }
                </style>
            </head>
            <body>
                ${container.innerHTML}
            </body>
            </html>
        `);

        printWindow.document.close();
        printWindow.focus();
        
        // Wait for images to load before printing
        setTimeout(() => {
            printWindow.print();
        }, 500);
    }

    // Submit batch for QC verification
    function submitForQC() {
        if (!confirm('Submit this batch for QC verification? All items must be complete before submission.')) {
            return;
        }

        const batchId = {{ batch.id }};
        
        fetch(`/multi-grn/batch/${batchId}/submit-qc`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✓ Batch successfully submitted for QC verification!');
                location.reload();
            } else {
                let errorMsg = 'Error submitting batch for QC: ' + data.error;
                if (data.incomplete_lines && data.incomplete_lines.length > 0) {
                    errorMsg += '\n\nIncomplete line items:\n' + data.incomplete_lines.join('\n');
                }
                alert(errorMsg);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Network error submitting batch for QC. Please try again.');
        });
    }

    // Reset rejected batch for resubmission
    function resetForResubmission() {
        if (!confirm('Reset this batch to draft status for editing and resubmission?')) {
            return;
        }

        const batchId = {{ batch.id }};
        
        fetch(`/multi-grn/batch/${batchId}/reset-for-resubmission`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✓ Batch reset successfully! You can now edit items and resubmit.');
                location.reload();
            } else {
                alert('Error resetting batch: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Network error resetting batch. Please try again.');
        });
    }

    // Initialize Feather icons
    document.addEventListener('DOMContentLoaded', function() {
        feather.replace();
    });
</script>
{% endblock %}
