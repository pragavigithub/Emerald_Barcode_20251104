{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('multi_grn.index') }}">Multiple GRN</a></li>
            <li class="breadcrumb-item active">Step 3: Select Line Items</li>
        </ol>
    </nav>

    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-list"></i> Step 3: Select Line Items</h4>
            <small>Customer: {{ batch.customer_name }}</small>
        </div>
        <div class="card-body">
            <form method="POST">
                {% for detail in po_details %}
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h5>PO #{{ detail.po_link.po_doc_num }}</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                <tr>
                                    <th style="width: 5%;">
                                        <input type="checkbox" class="form-check-input" 
                                               onclick="toggleAllLines({{ detail.po_link.id }}, this.checked)">
                                    </th>
                                    <th>Item Code</th>
                                    <th>Description</th>
                                    <th>Ordered Qty</th>
                                    <th>Open Qty</th>
                                    <th>Receiving Qty</th>
                                    <th>Warehouse</th>
                                    <th>Action</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for line in detail.lines %}
                                <tr>
                                    <td>
                                        <input type="checkbox" class="form-check-input line-checkbox" 
                                               name="lines_po_{{ detail.po_link.id }}[]"
                                               value='{{ line|tojson }}'
                                               data-po-id="{{ detail.po_link.id }}"
                                               data-line-num="{{ line.LineNum }}"
                                               onchange="updateSelectedCount()">
                                    </td>
                                    <td><strong>{{ line.ItemCode }}</strong></td>
                                    <td>{{ line.ItemDescription }}</td>
                                    <td>{{ line.Quantity }}</td>
                                    <td><span class="badge bg-info">{{ line.OpenQuantity }}</span></td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm" 
                                               name="qty_po_{{ detail.po_link.id }}_line_{{ line.LineNum }}"
                                               value="{{ line.OpenQuantity }}"
                                               min="0"
                                               max="{{ line.OpenQuantity }}"
                                               step="0.001"
                                               style="width: 100px;">
                                    </td>
                                    <td>{{ line.WarehouseCode }}</td>
                                    <td>

                                            <!-- Disabled button for closed items -->
                                            <button class="btn btn-sm btn-secondary add-item-btn" disabled
                                                    title="Cannot add items from closed PO lines">
                                                <i data-feather="x"></i> Closed
                                            </button>

                                            <!-- Enabled button for open items -->
                                            <button class="btn btn-sm btn-primary add-item-btn"
                                                    data-item-code="{{ line.get('ItemCode', '') }}"
                                                    data-item-name="{{ line.get('ItemDescription') }}"
                                                    data-uom="{{ line.get('UoMCode', line.get('UoMEntry')) }}"
                                                    data-warehouse="{{ line.get('WarehouseCode', 'WH001') }}"
                                                    data-po-item="{{ line|tojson|e }}"
                                                    data-ordered-qty="{{ line.get('Quantity') }}"
                                                    data-open-qty="{{ line.get('OpenQuantity', line.get('OpenQty')) }}"
                                                    data-line-status="{{ line.get('LineStatus') }}">
                                                <i data-feather="plus"></i> Add Item
                                            </button>

                                    </td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endfor %}

                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle"></i>
                    <strong>Instructions:</strong> 
                    <ol class="mb-0 mt-2">
                        <li>Check the boxes for line items you want to receive</li>
                        <li>Adjust the "Receiving Qty" if needed (defaults to Open Qty)</li>
                        <li>Click "Next: Enter Details" to proceed to warehouse, bin location, and batch/serial entry</li>
                    </ol>
                </div>

                <div class="alert alert-warning mt-2" id="selection-alert" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>No items selected!</strong> Please select at least one line item to proceed.
                </div>

                <div class="d-flex justify-content-between align-items-center mt-3">
                    <a href="{{ url_for('multi_grn.create_step2_select_pos', batch_id=batch.id) }}"
                       class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to PO Selection
                    </a>
                    <div>
                        <span id="selected-count" class="me-3 text-muted">
                            <i class="fas fa-check-square"></i> <strong>0</strong> items selected
                        </span>
                        <button type="submit" class="btn btn-primary btn-lg" onclick="return validateSelection()">
                            <i class="fas fa-arrow-right"></i> Next: Enter Details
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Add Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Item to GRN</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addItemForm" method="POST" action="{{ url_for('add_grpo_item', grpo_id=grpo_doc.id) }}" onsubmit="return prepareSerialDataForSubmit()">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="item_code" class="form-label">Item Code <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="item_code" name="item_code"
                               onchange="handleItemCodeChange()" required>
                    </div>
                    <div class="mb-3">
                        <label for="item_name" class="form-label">Item Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="item_name" name="item_name" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="quantity" class="form-label">Quantity <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="quantity" name="quantity" step="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="unit_of_measure" class="form-label">Unit of Measure (UoM) <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="unit_of_measure" name="unit_of_measure" value="EA" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Warehouse and Bin Location -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="warehouse_code" class="form-label">Warehouse <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="warehouse_code" name="warehouse_code"
                                       placeholder="Warehouse from PO" readonly required>
                                <small class="form-text text-muted">Warehouse code from Purchase Order</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="bin_location" class="form-label">Bin Location</label>
                                <div class="input-group">
                                    <select class="form-select" id="bin_select" onchange="handleBinSelection()">
                                        <option value="">Select Bin Location...</option>
                                    </select>
                                    <button class="btn btn-outline-secondary" type="button" onclick="toggleManualBin()" title="Enter manually">
                                        <i data-feather="edit-3"></i>
                                    </button>
                                </div>
                                <input type="text" class="form-control mt-2" id="bin_location" name="bin_location"
                                       placeholder="Or enter bin location manually" style="display: none;">
                            </div>
                        </div>
                    </div>

                    <!-- Serial/Batch Management Section -->
                    <!-- Standard Item Section (Hidden by default, shown for non-batch/non-serial items) -->
                    <div id="standard_item_section" style="display: none;">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="standard_expiration_date" class="form-label">Expiration Date (Optional)</label>
                                    <input type="date" class="form-control" id="standard_expiration_date" name="standard_expiration_date">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="standard_number_of_bags" class="form-label">Number of Bag</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="standard_number_of_bags" name="number_of_bags_NSB"
                                               placeholder="Enter number of bags for label printing" min="1" max="1000">
                                        <button class="btn btn-success" type="button" onclick="generateStandardBarcodeLabels()" title="Generate barcode labels for bags">
                                            <i data-feather="printer"></i> Generate Labels
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">Enter the number of bags to generate QR labels with PO, GRN date, expiry, item details (e.g., 5 will generate labels 1 of 5, 2 of 5, etc.)</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Batch Section (Hidden by default, shown for batch managed items) -->
                    <div id="batch_section" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="batch_number" class="form-label">Batch Number</label>
                                    <div class="input-group">
                                        <select class="form-select" id="batch_select" onchange="handleBatchSelection()" disabled>
                                            <option value="">Select Batch...</option>
                                        </select>
                                        <button class="btn btn-outline-secondary" type="button" onclick="toggleManualBatch()" title="Enter manually">
                                            <i data-feather="edit-3"></i>
                                        </button>
                                    </div>
                                    <div class="input-group mt-2" id="batch_number_manual_group" style="display: none;">
                                        <input type="text" class="form-control" id="batch_number" name="batch_number"
                                               placeholder="Or enter batch number manually">
                                        <button class="btn btn-outline-primary" type="button" onclick="generateBatchBarcode()" title="Generate barcode for batch">
                                            <i data-feather="maximize-2"></i> Generate Barcode
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="expiration_date" class="form-label">Expiration Date</label>
                                    <input type="date" class="form-control" id="expiration_date" name="expiration_date">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="number_of_bags" class="form-label">Number of Bags</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="number_of_bags" name="number_of_bags_Batch"
                                               placeholder="Enter number of bags for label printing" min="1" max="1000">
                                        <button class="btn btn-success" type="button" onclick="generateBarcodeLabels()" title="Generate barcode labels for bags">
                                            <i data-feather="printer"></i> Generate Labels
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">Enter the number of bags to generate barcode labels (e.g., 10 will generate labels 1 of 10, 2 of 10, etc.)</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Serial Number Section (Hidden by default, shown for serial managed items) -->
                    <div id="serial_section" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">
                                <i data-feather="hash"></i> Serial Numbers
                                <span class="badge bg-info">Required for Serial Managed Items</span>
                            </label>
                            <div id="serial_numbers_container" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                <!-- Serial number inputs will be dynamically generated here -->
                            </div>
                            <input type="hidden" id="serial_numbers_json" name="serial_numbers_json">
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="serial_number_of_bags" class="form-label">Number of Bags </label>
                                    <input type="number" class="form-control" id="serial_number_of_bags" name="number_of_bags_serials"
                                           placeholder="Enter number of bags for label printing" min="1" max="1000" >
                                    <small class="form-text text-muted">Enter the number of bags to generate barcode labels (e.g., if you have 100 serials and enter 5, each bag will contain 20 serials)</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden field for batch numbers JSON -->
                    <input type="hidden" id="batch_numbers_json" name="batch_numbers_json">

                    <!-- Hidden field for GRN date (for label generation) -->
                    <input type="hidden" id="grn_date" value="{{ grpo_doc.created_at.strftime('%Y-%m-%d') }}">

<!--                    <div class="mb-3">-->
<!--                        <label for="barcode" class="form-label">Supplier Barcode</label>-->
<!--                        <input type="text" class="form-control" id="barcode" name="barcode" placeholder="Scan or enter supplier barcode">-->
<!--                    </div>-->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Item</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Barcode Labels Modal -->
<div class="modal fade" id="barcodeLabelsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Batch Item Barcode Labels</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="barcodeLabelsContent">
                <!-- Labels will be generated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="window.print()">
                    <i data-feather="printer"></i> Print Labels
                </button>
            </div>
        </div>
    </div>
</div>
<script>
    // Toggle all checkboxes for a specific PO
    function toggleAllLines(poId, checked) {
        const checkboxes = document.querySelectorAll(`input[data-po-id="${poId}"].line-checkbox`);
        checkboxes.forEach(cb => cb.checked = checked);
        updateSelectedCount();
    }

    // Update the selected count display
    function updateSelectedCount() {
        const selectedCheckboxes = document.querySelectorAll('.line-checkbox:checked');
        const count = selectedCheckboxes.length;
        document.getElementById('selected-count').innerHTML = 
            `<i class="fas fa-check-square"></i> <strong>${count}</strong> item${count !== 1 ? 's' : ''} selected`;
    }

    // Validate that at least one item is selected before submitting
    function validateSelection() {
        const selectedCheckboxes = document.querySelectorAll('.line-checkbox:checked');
        
        if (selectedCheckboxes.length === 0) {
            document.getElementById('selection-alert').style.display = 'block';
            window.scrollTo(0, 0);
            return false;
        }
        
        // Hide alert if it was showing
        document.getElementById('selection-alert').style.display = 'none';
        return true;
    }

    // Enable/disable quantity input based on checkbox state
    document.addEventListener('DOMContentLoaded', function() {
        const checkboxes = document.querySelectorAll('.line-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const poId = this.dataset.poId;
                const lineNum = this.dataset.lineNum;
                const qtyInput = document.querySelector(`input[name="qty_po_${poId}_line_${lineNum}"]`);
                
                if (qtyInput) {
                    qtyInput.disabled = !this.checked;
                    if (this.checked) {
                        qtyInput.style.backgroundColor = '';
                    } else {
                        qtyInput.style.backgroundColor = '#f0f0f0';
                    }
                }
            });
            
            // Trigger change event to set initial state
            checkbox.dispatchEvent(new Event('change'));
        });
    });
</script>
{% endblock %}
