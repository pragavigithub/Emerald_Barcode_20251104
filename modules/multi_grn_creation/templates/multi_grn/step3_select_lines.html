{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('multi_grn.index') }}">Multiple GRN</a></li>
            <li class="breadcrumb-item active">Step 3: Select Line Items</li>
        </ol>
    </nav>

    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-list"></i> Step 3: Select Line Items</h4>
            <small>Customer: {{ batch.customer_name }}</small>
        </div>
        <div class="card-body">
            <form method="POST">
                {% for detail in po_details %}
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h5>PO #{{ detail.po_link.po_doc_num }}</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                <tr>
                                    <th style="width: 5%;">
                                        <input type="checkbox" class="form-check-input" 
                                               onclick="toggleAllLines({{ detail.po_link.id }}, this.checked)">
                                    </th>
                                    <th>Item Code</th>
                                    <th>Description</th>
                                    <th>Ordered Qty</th>
                                    <th>Open Qty</th>
                                    <th>Receiving Qty</th>
                                    <th>Warehouse</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for line in detail.lines %}
                                <tr>
                                    <td>
                                        <input type="checkbox" class="form-check-input line-checkbox" 
                                               name="lines_po_{{ detail.po_link.id }}[]"
                                               value='{{ line|tojson }}'
                                               data-po-id="{{ detail.po_link.id }}"
                                               data-line-num="{{ line.LineNum }}"
                                               onchange="updateSelectedCount()">
                                    </td>
                                    <td><strong>{{ line.ItemCode }}</strong></td>
                                    <td>{{ line.ItemDescription }}</td>
                                    <td>{{ line.Quantity }}</td>
                                    <td><span class="badge bg-info">{{ line.OpenQuantity }}</span></td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm" 
                                               name="qty_po_{{ detail.po_link.id }}_line_{{ line.LineNum }}"
                                               value="{{ line.OpenQuantity }}"
                                               min="0"
                                               max="{{ line.OpenQuantity }}"
                                               step="0.001"
                                               style="width: 100px;">
                                    </td>
                                    <td>{{ line.WarehouseCode }}</td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endfor %}

                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle"></i>
                    <strong>Instructions:</strong> 
                    <ol class="mb-0 mt-2">
                        <li>Check the boxes for line items you want to receive</li>
                        <li>Adjust the "Receiving Qty" if needed (defaults to Open Qty)</li>
                        <li>Click "Next: Enter Details" to proceed to warehouse, bin location, and batch/serial entry</li>
                    </ol>
                </div>

                <div class="alert alert-warning mt-2" id="selection-alert" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>No items selected!</strong> Please select at least one line item to proceed.
                </div>

                <div class="d-flex justify-content-between align-items-center mt-3">
                    <a href="{{ url_for('multi_grn.create_step2_select_pos', batch_id=batch.id) }}"
                       class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to PO Selection
                    </a>
                    <div>
                        <span id="selected-count" class="me-3 text-muted">
                            <i class="fas fa-check-square"></i> <strong>0</strong> items selected
                        </span>
                        <button type="submit" class="btn btn-primary btn-lg" onclick="return validateSelection()">
                            <i class="fas fa-arrow-right"></i> Next: Enter Details
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Toggle all checkboxes for a specific PO
    function toggleAllLines(poId, checked) {
        const checkboxes = document.querySelectorAll(`input[data-po-id="${poId}"].line-checkbox`);
        checkboxes.forEach(cb => cb.checked = checked);
        updateSelectedCount();
    }

    // Update the selected count display
    function updateSelectedCount() {
        const selectedCheckboxes = document.querySelectorAll('.line-checkbox:checked');
        const count = selectedCheckboxes.length;
        document.getElementById('selected-count').innerHTML = 
            `<i class="fas fa-check-square"></i> <strong>${count}</strong> item${count !== 1 ? 's' : ''} selected`;
    }

    // Validate that at least one item is selected before submitting
    function validateSelection() {
        const selectedCheckboxes = document.querySelectorAll('.line-checkbox:checked');
        
        if (selectedCheckboxes.length === 0) {
            document.getElementById('selection-alert').style.display = 'block';
            window.scrollTo(0, 0);
            return false;
        }
        
        // Hide alert if it was showing
        document.getElementById('selection-alert').style.display = 'none';
        return true;
    }

    // Enable/disable quantity input based on checkbox state
    document.addEventListener('DOMContentLoaded', function() {
        const checkboxes = document.querySelectorAll('.line-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const poId = this.dataset.poId;
                const lineNum = this.dataset.lineNum;
                const qtyInput = document.querySelector(`input[name="qty_po_${poId}_line_${lineNum}"]`);
                
                if (qtyInput) {
                    qtyInput.disabled = !this.checked;
                    if (this.checked) {
                        qtyInput.style.backgroundColor = '';
                    } else {
                        qtyInput.style.backgroundColor = '#f0f0f0';
                    }
                }
            });
            
            // Trigger change event to set initial state
            checkbox.dispatchEvent(new Event('change'));
        });
    });
</script>
{% endblock %}
