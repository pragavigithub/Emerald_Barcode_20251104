# Warehouse Management System (WMS)

## Overview
A Flask-based Warehouse Management System (WMS) designed to streamline inventory operations by integrating seamlessly with SAP for functionalities such as barcode scanning, goods receipt, pick list generation, and inventory transfers. The system aims to enhance efficiency, accuracy, and control over warehouse logistics, ultimately minimizing manual errors and maximizing throughput for small to medium-sized enterprises.

## User Preferences
*   Keep MySQL migration files updated when database schema changes occur
*   SQL query validation should only run on initial startup, not on every application restart

## System Architecture
The system is built on a Flask web application backend, utilizing Jinja2 for server-side rendering. A core architectural decision is the deep integration with the SAP B1 Service Layer API for all critical warehouse operations, ensuring data consistency and real-time updates. PostgreSQL is the primary database target for cloud deployments, with SQLite serving as a fallback. User authentication uses Flask-Login with robust role-based access control. The application is designed for production deployment using Gunicorn with autoscale capabilities.

**Key Features:**
*   **User Management:** Comprehensive authentication, role-based access, and self-service profile management with deactivation for audit trails.
*   **GRPO Management:** Standard Goods Receipt PO processing, intelligent batch/serial field management, and a module for batch creation of multiple GRNs from multiple Purchase Orders via a 5-step workflow with SAP B1 integration. It includes dynamic batch/serial detection and specific entry processes for serial and batch numbers. Full QR label generation for multi GRN module supporting serial-managed, batch-managed, and standard/non-managed items.
    *   **Multi GRN Document Series Selection (Nov 2025):** Enhanced Step 1 workflow now includes Document Series dropdown selection using SAP B1 SQL Query `Get_PO_Series`. Step 2 filters PO documents by both Document Series and CardCode using SQL Query `Get_Multi_Open_PO_DocNum`. Database model updated to store `doc_series_id` and `doc_series_name` for each batch. Provides better organization and filtering capabilities for large datasets.
    *   **Multi GRN CardCode Dropdown by SeriesID (Nov 10, 2025):** Step 1 now features a cascading dropdown where CardCode selection is dependent on the selected Document Series. When a Document Series is selected, the system fetches and displays only CardCodes associated with that series using SAP B1 SQL Query `Get_CarCode_BySeriesID`. The CardCode dropdown is disabled until a Series is selected, providing better user experience and data filtering. Implementation includes robust security validation to prevent SQL injection, with dual-layer integer validation in both API endpoint and service layer. API endpoint: `/multi-grn/api/cardcodes-by-series`.
    *   **Multi GRN Line-Item-Wise Detail Entry (Nov 2025):** Step 3 now displays ONLY open line items (LineStatus='bost_Open') from selected POs, grouped by PO document number. Users click "Add Item" per line to enter serial/batch/non-managed details using the same validation logic as the GRPO module. New `MultiGRNNonManagedDetail` model supports non-batch, non-serial managed items with DECIMAL(15,3) quantity types for fractional handling. API endpoint `/multi-grn/api/open-lines/<batch_id>` fetches filtered open lines via `SAPMultiGRNService.fetch_open_line_items()` method. Each line tracks completion status (`is_complete` field), and QC submission validates all lines are complete before allowing submission.
    *   **Multi GRN Full Feature Parity with GRPO (Nov 10, 2025):** Enhanced form submission handler in step3_detail.html to immediately persist all batch/serial/standard item details when clicking "Save Details" button, matching GRPO module behavior. Form now saves: (1) Batch-managed items: batch_number, expiry_date, no_of_packs, qty_per_pack via `/api/line-selections/{id}/batch-details` endpoint, (2) Serial-managed items: manufacturer_serial_number, internal_serial_number, no_of_packs via `/api/line-selections/{id}/serial-details` endpoint, (3) Standard/non-managed items: expiry_date, no_of_packs, qty_per_pack via `/api/line-selections/{id}/non-managed-details` endpoint. QR label generation remains a separate optional step after saving item details. Prevents data loss and ensures complete item detail capture before label generation.
    *   **Multi GRN QC Workflow (Nov 2025):** Enhanced workflow requiring QC approval before SAP posting. Users add all line items in Step 3 and submit for QC verification. QC users access a dedicated dashboard to approve/reject batches. Rejected batches can be reset and resubmitted after corrections. Workflow: Draft → Collecting → Submit for QC → Pending QC → QC Approved → Post to SAP. Includes comprehensive tracking of QC approver, timestamps, and rejection notes.
    *   **Multi GRN SAP Posting Resilience (Nov 10, 2025):** Implemented idempotent posting flow with automatic retry capability for SAP posting failures. When SAP posting encounters errors (partial or full failure), the batch remains in 'qc_approved' status instead of terminal 'failed' state, allowing QC users to retry posting. Features include: (1) Dual idempotency checks in both posting endpoints to prevent duplicate GRN creation, (2) Per-PO-link error tracking via `error_message` field, (3) Batch-level error diagnostics in `error_log` field with actionable guidance, (4) New `/batch/<id>/retry-posting` endpoint restricted to QC/Manager roles that retries only failed PO links, (5) Automatic batch completion when all PO links successfully post. Supports partial success scenarios where some PO links post successfully while others fail, preserving successful postings and allowing retry of only failed items.
    *   **Compact QR Code Format (Nov 2025):** Multi GRN module updated to use compact JSON format matching GRPO module: `{"id":"GRN/29/0000000001","po":"252630008","item":"BatchItem_01","batch":"BATCHAH999389","qty":1,"pack":"1 of 10","grn_date":"2025-10-29","exp_date":"2025-12-06"}`. Uses json.dumps with separators=(',',':') for minimal whitespace. Added admin_date field to MultiGRNBatchDetails and MultiGRNSerialDetails models to track administrative dates for each pack.
*   **Inventory Transfer:** Enhanced module for creating inventory transfer requests with document series selection and SAP B1 validation. Includes ItemCode validation with automatic item type detection (Serial/Batch/Non-Managed) and dynamic warehouse selection based on real-time SAP B1 data. Features barcode-based inventory transfer with automatic serial/batch detection, real-time SAP B1 validation, intelligent serial number tracking, batch number validation, warehouse and bin selection via SAP, QC approval workflow, and direct posting to SAP B1 as StockTransfers documents. Supports comprehensive pagination, filtering, and search functionality.
*   **Sales Order Against Delivery:** Module for creating Delivery Notes against Sales Orders with SAP B1 integration, including SO series dropdown selection, cascading dropdown for open SO document numbers, document loading, item picking with batch/serial validation, individual QR code label generation, and direct SAP B1 posting.
*   **Pick List Management:** Generation and processing of pick lists.
*   **Barcode Scanning:** Integrated camera-based scanning for various modules (GRPO, Bin Scanning, Pick List, Inventory Transfer, Barcode Reprint).
*   **Inventory Counting:** SAP B1 integrated inventory counting with local PostgreSQL database storage for tracking, audit trails, user tracking, and timestamps. Includes a comprehensive history view for all counted and posted documents, with dashboard integration showing statistics and recent counting activities.
*   **Branch Management:** Functionality for managing different warehouse branches.
*   **Quality Control Dashboard:** Provides oversight for quality processes across GRPO, Inventory Transfer, and Multi GRN modules. Template rendering enhanced (Nov 10, 2025) with robust datetime field handling to safely process datetime objects, string values, and null values, preventing strftime AttributeErrors on null timestamps.
*   **UI/UX:** Focuses on intuitive workflows for managing inventory, including serial number transfers and real-time validation against SAP B1.
*   **Database Migrations:** A comprehensive MySQL migration tracking system is in place for schema changes, complementing the primary PostgreSQL strategy. Consolidated migration file `mysql_multi_grn_consolidated.sql` fully synchronized (Nov 10, 2025) with all Multi GRN schema changes including QC workflow fields (qc_status, qc_approver_id, qc_reviewed_at, qc_notes, submitted_at, posted_by_id), document series tracking (doc_series_id, doc_series_name), detail management fields (is_complete, admin_date, expiry_date, qty_per_pack, no_of_packs), and multi_grn_non_managed_details table for non-batch/non-serial items with proper foreign keys and indexes.
*   **SAP SQL Query Validation:** Optimized to run only on initial startup, improving performance.

**Technical Implementations:**
*   **SAP B1 Integration:** Utilizes a dedicated `SAPMultiGRNService` class for secure and robust communication with the SAP B1 Service Layer, including SSL/TLS verification and optimized OData filtering.
*   **Modular Design:** New features are implemented as modular blueprints with their own templates and services.
*   **Frontend:** Jinja2 templating with JavaScript libraries like Select2 for enhanced UI components.
*   **Error Handling:** Comprehensive validation and error logging for API communications and user inputs.

## External Dependencies
*   **SAP B1 Service Layer API**: For all core inventory and document management functionalities (GRPO, pick lists, inventory transfers, serial numbers, business partners, inventory counts).
*   **PostgreSQL**: Primary relational database for production environments.
*   **SQLite**: Local relational database for development and initial setup.
*   **Gunicorn**: WSGI HTTP server for deploying the Flask application in production.
*   **Flask-Login**: Library for managing user sessions and authentication.